{% extends "base.html" %}

{% block title %}Content Management - YouTube Automation{% endblock %}

{% block page_title %}Content Management{% endblock %}

{% block extra_css %}
<style>
    .content-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        padding-bottom: 16px;
        border-bottom: 1px solid var(--buffer-border);
    }
    
    .bulk-actions {
        display: flex;
        gap: 12px;
        align-items: center;
    }
    
    .video-card {
        background: var(--buffer-card-bg);
        border: 1px solid var(--buffer-border);
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 24px;
        transition: box-shadow 0.3s, border-color 0.3s;
    }
    
    .video-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .video-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 16px;
    }
    
    .video-title-section {
        flex: 1;
    }
    
    .video-title {
        font-size: 20px;
        font-weight: 600;
        color: var(--buffer-text);
        margin-bottom: 8px;
    }
    
    .video-meta {
        display: flex;
        gap: 16px;
        font-size: 14px;
        color: var(--buffer-text-light);
        margin-bottom: 16px;
    }
    
    .video-meta-item {
        display: flex;
        align-items: center;
        gap: 6px;
    }
    
    .video-youtube-info {
        background: var(--buffer-bg-light);
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 16px;
    }
    
    .youtube-info-label {
        font-weight: 600;
        color: var(--buffer-text);
        margin-bottom: 8px;
        font-size: 14px;
    }
    
    .youtube-info-content {
        font-size: 14px;
        color: var(--buffer-text-light);
        line-height: 1.6;
    }
    
    .youtube-info-content strong {
        color: var(--buffer-text);
    }
    
    .tags {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 8px;
    }
    
    .tag {
        padding: 4px 10px;
        background: var(--buffer-hover);
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
        color: var(--buffer-text);
    }
    
    .platforms-section {
        margin-top: 24px;
        padding-top: 24px;
        border-top: 1px solid var(--buffer-border);
    }
    
    .platforms-header {
        font-weight: 600;
        font-size: 16px;
        color: var(--buffer-text);
        margin-bottom: 16px;
    }
    
    .platform-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 16px;
    }
    
    .platform-card {
        background: var(--buffer-bg-light);
        border: 1px solid var(--buffer-border);
        border-radius: 8px;
        padding: 16px;
    }
    
    .platform-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
    }
    
    .platform-name {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
        font-size: 14px;
    }
    
    .platform-icon {
        width: 20px;
        height: 20px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
    }
    
    .platform-icon.linkedin {
        background: #0077b5;
        color: white;
    }
    
    .platform-icon.facebook {
        background: #1877f2;
        color: white;
    }
    
    .platform-icon.instagram {
        background: linear-gradient(45deg, #f09433 0%,#e6683c 25%,#dc2743 50%,#cc2366 75%,#bc1888 100%);
        color: white;
    }
    
    .status-badge {
        padding: 4px 10px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
    }
    
    .status-not_scheduled {
        background: #f3f4f6;
        color: #6b7280;
    }
    
    .status-pending {
        background: #fef3c7;
        color: #92400e;
    }
    
    .status-scheduled {
        background: #dbeafe;
        color: #1e40af;
    }
    
    .status-posted {
        background: #d1fae5;
        color: #065f46;
    }
    
    .status-error {
        background: #fee2e2;
        color: #991b1b;
    }
    
    .post-content {
        background: white;
        border-radius: 6px;
        padding: 12px;
        margin-top: 12px;
        font-size: 13px;
        line-height: 1.6;
        color: var(--buffer-text);
        white-space: pre-wrap;
        max-height: 150px;
        overflow-y: auto;
    }
    
    .schedule-date {
        font-size: 12px;
        color: var(--buffer-text-light);
        margin-top: 8px;
    }
    
    .platform-actions {
        display: flex;
        gap: 8px;
        margin-top: 12px;
    }
    
    .btn-sm {
        padding: 6px 12px;
        font-size: 12px;
    }
    
    .loading {
        text-align: center;
        padding: 48px;
        color: var(--buffer-text-light);
    }
    
    .empty-state {
        text-align: center;
        padding: 64px 24px;
        color: var(--buffer-text-light);
    }
    
    .empty-state i {
        font-size: 48px;
        margin-bottom: 16px;
        color: var(--buffer-border);
    }
</style>
{% endblock %}

{% block content %}
<div class="content-header">
    <div>
        <h2 style="margin: 0; font-size: 24px; font-weight: 600; color: var(--buffer-text);">Content Management</h2>
        <p style="margin: 8px 0 0 0; color: var(--buffer-text-light); font-size: 14px;">
            Manage and schedule your videos across all social media channels
        </p>
    </div>
    <div class="bulk-actions">
        <button class="btn btn-primary" onclick="scheduleAll()" id="scheduleAllBtn">
            <i class="bi bi-calendar-check"></i> Schedule All
        </button>
        <button class="btn btn-outline-secondary" onclick="refreshContent()" id="refreshBtn">
            <i class="bi bi-arrow-clockwise"></i> Refresh
        </button>
    </div>
</div>

<div id="content-container">
    <div class="loading">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading videos...</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let allVideos = [];
let configuredPlatforms = ['linkedin', 'facebook', 'instagram']; // Will be fetched from API

document.addEventListener('DOMContentLoaded', function() {
    loadContent();
    loadConfiguredPlatforms();
});

function loadConfiguredPlatforms() {
    // Fetch configured platforms from settings
    fetch('/api/config/platforms')
        .then(response => response.json())
        .then(data => {
            if (data.platforms) {
                configuredPlatforms = data.platforms;
            }
        })
        .catch(err => console.error('Error loading platforms:', err));
}

function loadContent() {
    const container = document.getElementById('content-container');
    container.innerHTML = `
        <div class="loading">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading videos...</p>
        </div>
    `;
    
    fetch('/api/content/videos')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                container.innerHTML = `<div class="alert alert-danger">Error: ${data.error}</div>`;
                return;
            }
            
            allVideos = data.videos || [];
            
            if (allVideos.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-inbox"></i>
                        <h3>No videos found</h3>
                        <p>No public or scheduled videos found. Videos will appear here once they are published or scheduled on YouTube.</p>
                    </div>
                `;
                return;
            }
            
            renderVideos(allVideos);
        })
        .catch(error => {
            console.error('Error loading content:', error);
            container.innerHTML = `<div class="alert alert-danger">Error loading videos: ${error.message}</div>`;
        });
}

function renderVideos(videos) {
    const container = document.getElementById('content-container');
    
    let html = '';
    videos.forEach(video => {
        html += renderVideoCard(video);
    });
    
    container.innerHTML = html;
}

function renderVideoCard(video) {
    const tags = video.tags ? video.tags.split(',').filter(t => t.trim()) : [];
    const customTags = video.custom_tags ? video.custom_tags.split(',').filter(t => t.trim()) : [];
    const youtubeDate = video.youtube_schedule_date || video.youtube_published_date;
    
    let html = `
        <div class="video-card" data-video-id="${video.video_id}">
            <div class="video-header">
                <div class="video-title-section">
                    <div class="video-title">
                        <a href="${video.youtube_url}" target="_blank" style="color: inherit; text-decoration: none;">
                            ${escapeHtml(video.title)}
                            <i class="bi bi-box-arrow-up-right" style="font-size: 14px; margin-left: 6px;"></i>
                        </a>
                    </div>
                    <div class="video-meta">
                        ${video.playlist_name ? `<span class="video-meta-item"><i class="bi bi-collection-play"></i> ${escapeHtml(video.playlist_name)}</span>` : ''}
                        ${video.video_type ? `<span class="video-meta-item"><i class="bi bi-tag"></i> ${escapeHtml(video.video_type)}</span>` : ''}
                        ${video.role ? `<span class="video-meta-item"><i class="bi bi-person"></i> ${escapeHtml(video.role)}</span>` : ''}
                        ${youtubeDate ? `<span class="video-meta-item"><i class="bi bi-calendar"></i> ${formatDate(youtubeDate)}</span>` : ''}
                    </div>
                </div>
            </div>
            
            <div class="video-youtube-info">
                <div class="youtube-info-label">YouTube Information</div>
                ${video.description ? `<div class="youtube-info-content"><strong>Description:</strong> ${escapeHtml(video.description.substring(0, 200))}${video.description.length > 200 ? '...' : ''}</div>` : ''}
                ${tags.length > 0 ? `
                    <div class="youtube-info-content" style="margin-top: 8px;">
                        <strong>Tags:</strong>
                        <div class="tags">
                            ${tags.map(tag => `<span class="tag">${escapeHtml(tag.trim())}</span>`).join('')}
                        </div>
                    </div>
                ` : ''}
                ${customTags.length > 0 ? `
                    <div class="youtube-info-content" style="margin-top: 8px;">
                        <strong>Custom Tags:</strong>
                        <div class="tags">
                            ${customTags.map(tag => `<span class="tag">${escapeHtml(tag.trim())}</span>`).join('')}
                        </div>
                    </div>
                ` : ''}
            </div>
            
            <div class="platforms-section">
                <div class="platforms-header">Social Media Channels</div>
                <div class="platform-cards">
                    ${renderPlatformCard('linkedin', video.platforms.linkedin, video)}
                    ${renderPlatformCard('facebook', video.platforms.facebook, video)}
                    ${renderPlatformCard('instagram', video.platforms.instagram, video)}
                </div>
            </div>
        </div>
    `;
    
    return html;
}

function renderPlatformCard(platform, platformData, video) {
    const platformNames = {
        'linkedin': 'LinkedIn',
        'facebook': 'Facebook',
        'instagram': 'Instagram'
    };
    
    const status = platformData.status || 'not_scheduled';
    const scheduleDate = platformData.schedule_date || '';
    const postContent = platformData.post_content || '';
    
    let statusHtml = '';
    if (status === 'not_scheduled') {
        statusHtml = '<span class="status-badge status-not_scheduled">Not Scheduled</span>';
    } else if (status === 'pending') {
        statusHtml = '<span class="status-badge status-pending">Pending</span>';
    } else if (status === 'scheduled') {
        statusHtml = '<span class="status-badge status-scheduled">Scheduled</span>';
    } else if (status === 'posted') {
        statusHtml = '<span class="status-badge status-posted">Posted</span>';
    } else if (status === 'error') {
        statusHtml = '<span class="status-badge status-error">Error</span>';
    }
    
    const actionsHtml = status === 'not_scheduled' || status === 'pending' ? `
        <div class="platform-actions">
            <button class="btn btn-sm btn-primary" onclick="scheduleVideo('${video.video_id}', '${platform}')">
                <i class="bi bi-calendar-plus"></i> Schedule
            </button>
            ${postContent ? `
                <button class="btn btn-sm btn-outline-secondary" onclick="viewPost('${video.video_id}', '${platform}')">
                    <i class="bi bi-eye"></i> View Post
                </button>
            ` : `
                <button class="btn btn-sm btn-outline-secondary" onclick="generatePost('${video.video_id}', '${platform}')">
                    <i class="bi bi-magic"></i> Generate Post
                </button>
            `}
        </div>
    ` : scheduleDate ? `
        <div class="schedule-date">
            <i class="bi bi-clock"></i> Scheduled: ${formatDate(scheduleDate)}
        </div>
    ` : '';
    
    return `
        <div class="platform-card">
            <div class="platform-header">
                <div class="platform-name">
                    <span class="platform-icon ${platform}">
                        <i class="bi bi-${platform === 'linkedin' ? 'linkedin' : (platform === 'facebook' ? 'facebook' : 'instagram')}"></i>
                    </span>
                    ${platformNames[platform]}
                </div>
                ${statusHtml}
            </div>
            ${postContent ? `
                <div class="post-content">${escapeHtml(postContent)}</div>
            ` : `
                <div class="post-content" style="color: var(--buffer-text-light); font-style: italic;">
                    No post content generated yet. Click "Generate Post" to create one.
                </div>
            `}
            ${actionsHtml}
        </div>
    `;
}

function scheduleVideo(videoId, platform) {
    if (!confirm(`Schedule this video on ${platform}?`)) return;
    
    // Open schedule modal (to be implemented)
    alert(`Schedule video on ${platform} - Coming soon!\n\nThis will allow you to:\n- Set date/time\n- Review post content\n- Schedule the post`);
}

function viewPost(videoId, platform) {
    const video = allVideos.find(v => v.video_id === videoId);
    if (!video) return;
    
    const postContent = video.platforms[platform].post_content;
    alert(`Post Content for ${platform}:\n\n${postContent}`);
}

function generatePost(videoId, platform) {
    alert(`Generate post for ${platform} - Coming soon!\n\nThis will automatically generate post content based on video title and description.`);
}

function scheduleAll() {
    if (!confirm('Schedule all unscheduled videos across all platforms?')) return;
    
    alert('Bulk schedule - Coming soon!\n\nThis will schedule all videos that are not yet scheduled.');
}

function refreshContent() {
    loadContent();
}

function formatDate(dateStr) {
    if (!dateStr) return '';
    try {
        const date = new Date(dateStr);
        return date.toLocaleString('en-US', { 
            year: 'numeric', 
            month: 'short', 
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    } catch {
        return dateStr;
    }
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}


