{% extends "base.html" %}

{% block title %}Configuration - YouTube Automation{% endblock %}

{% block page_title %}Settings{% endblock %}

{% block content %}
<!-- Configuration Status Checklist -->
<div class="card mb-4" style="border-left: 4px solid var(--primary);">
    <div class="card-header d-flex justify-content-between align-items-center">
        <div>
            <i class="bi bi-check2-square"></i> Configuration Status
        </div>
        <span class="badge bg-{{ 'success' if config_complete else 'warning' }}">
            {{ 'Complete' if config_complete else 'Incomplete' }}
        </span>
    </div>
    <div class="card-body">
        <div class="config-checklist">
            <div class="row">
                <div class="col-md-6">
                    <h6 class="mb-3"><i class="bi bi-youtube text-danger"></i> YouTube</h6>
                    <div class="checklist-item {{ 'completed' if settings.api_keys.facebook_page_access_token and settings.api_keys.facebook_page_id else 'pending' }}">
                        <i class="bi bi-{{ 'check-circle-fill text-success' if settings.api_keys.facebook_page_access_token and settings.api_keys.facebook_page_id else 'circle text-muted' }}"></i>
                        <span>Page Access Token & Page ID</span>
                        {% if settings.api_keys.facebook_page_access_token and settings.api_keys.facebook_page_id %}
                        <span class="badge bg-success ms-2">Configured</span>
                        {% else %}
                        <span class="badge bg-warning ms-2">Pending</span>
                        {% endif %}
                    </div>
                    <div class="checklist-item {{ 'completed' if settings.api_keys.facebook_page_access_token and settings.api_keys.facebook_page_id else 'pending' }}">
                        <i class="bi bi-{{ 'check-circle-fill text-success' if settings.api_keys.facebook_page_access_token and settings.api_keys.facebook_page_id else 'circle text-muted' }}"></i>
                        <span>Page Access Token & Page ID</span>
                        {% if settings.api_keys.facebook_page_access_token and settings.api_keys.facebook_page_id %}
                        <span class="badge bg-success ms-2">Configured</span>
                        {% else %}
                        <span class="badge bg-warning ms-2">Pending</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Buffer-Style One-Click Connections -->
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        <div class="container mt-3">
            {% for category, message in messages %}
                <div class="alert alert-{{ 'danger' if category == 'error' else 'success' if category == 'success' else 'info' }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        </div>
    {% endif %}
{% endwith %}

<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div id="social-media-connections"></div>
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-plug"></i> Connect Social Media Accounts</h5>
                    <small>One-click connection - just like Buffer.com! Login and we&apos;ll collect everything automatically.</small>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <!-- LinkedIn Connection -->
                        <div class="col-md-6">
                            <div class="card h-100 border">
                                <div class="card-body text-center">
                                    <div class="mb-3">
                                        <i class="bi bi-linkedin" style="font-size: 3rem; color: #0077b5;"></i>
                                    </div>
                                    <h6>LinkedIn</h6>
                                    {% if settings.api_keys.linkedin_access_token and settings.api_keys.linkedin_person_urn %}
                                        <div class="alert alert-success mb-3">
                                            <i class="bi bi-check-circle"></i> Connected
                                            <br><small>Token: {{ settings.api_keys.linkedin_access_token[:20] }}...</small>
                                            <br><small>Person URN: {{ settings.api_keys.linkedin_person_urn }}</small>
                                        </div>
                                        <button class="btn btn-outline-primary btn-sm" onclick="disconnectLinkedIn()">
                                            <i class="bi bi-x-circle"></i> Disconnect
                                        </button>
                                    {% else %}
                                        <p class="text-muted small mb-3">Click the button below to connect your LinkedIn account. We'll automatically fetch your Access Token and Person URN.</p>
                                        {% if settings.api_keys.linkedin_client_id and settings.api_keys.linkedin_client_secret %}
                                            <a href="/api/linkedin/oauth/authorize" class="btn btn-primary btn-lg w-100">
                                                <i class="bi bi-box-arrow-in-right"></i> Connect LinkedIn & Fetch All Details
                                            </a>
                                            <small class="text-muted d-block mt-2">
                                                <i class="bi bi-info-circle"></i> This will open LinkedIn login, then automatically collect your Access Token and Person URN
                                            </small>
                                        {% else %}
                                            <div class="alert alert-warning mb-3">
                                                <i class="bi bi-exclamation-triangle"></i>
                                                <strong>Setup Required:</strong> Please add LinkedIn Client ID & Secret first in the API Keys section below, then come back here to connect.
                                            </div>
                                            <a href="#api_keys" class="btn btn-outline-primary btn-sm">
                                                <i class="bi bi-arrow-down"></i> Go to API Keys Section
                                            </a>
                                        {% endif %}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Facebook Connection -->
                        <div class="col-md-6">
                            <div class="card h-100 border">
                                <div class="card-body text-center">
                                    <div class="mb-3">
                                        <i class="bi bi-facebook" style="font-size: 3rem; color: #1877f2;"></i>
                                    </div>
                                    <h6>Facebook & Instagram</h6>
                                    {% if settings.api_keys.facebook_page_access_token and settings.api_keys.facebook_page_id %}
                                        <div class="alert alert-success mb-3">
                                            <i class="bi bi-check-circle"></i> Connected
                                            <br><small>Page ID: {{ settings.api_keys.facebook_page_id }}</small>
                                            <br><small>Token: {{ settings.api_keys.facebook_page_access_token[:20] }}...</small>
                                            {% if settings.api_keys.instagram_business_account_id %}
                                                <br><small>Instagram Account: {{ settings.api_keys.instagram_business_account_id }}</small>
                                            {% endif %}
                                        </div>
                                        <button class="btn btn-outline-primary btn-sm" onclick="disconnectFacebook()">
                                            <i class="bi bi-x-circle"></i> Disconnect
                                        </button>
                                    {% else %}
                                        <p class="text-muted small mb-3">Connect Facebook to post to Facebook Pages and Instagram</p>
                                        <a href="/api/facebook/oauth/authorize" class="btn btn-primary mb-2">
                                            <i class="bi bi-box-arrow-in-right"></i> Connect Facebook
                                        </a>
                                        <div class="mt-2">
                                            <small class="text-muted d-block mb-1">Or use:</small>
                                            <a href="/facebook-token-helper" target="_blank" class="btn btn-outline-primary btn-sm">
                                                <i class="bi bi-tools"></i> Token Helper
                                            </a>
                                        </div>
                                        <div class="alert alert-info mt-2 mb-0" style="font-size: 0.75rem;">
                                            <strong>Tip:</strong> Use Graph API Explorer method for easiest setup
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Anchor IDs for hash navigation -->
<div id="api_keys"></div>
<div id="scheduling"></div>
<div id="targeting-settings"></div>
<div id="channels"></div>

<script>
    // Auto-dismiss after 3 seconds
                setTimeout(() => {
                    if (saveIndicator && saveIndicator.parentElement) {
                        saveIndicator.remove();
                    }
                }, 3000);
                
                // Reset button after 2 seconds
                setTimeout(() => {
                    icon.className = originalIcon;
                    btnText.textContent = originalText;
                    button.classList.remove('btn-success');
                    button.classList.add('btn-primary');
                    button.disabled = false;
                }, 2000);
            } else {
                // Error feedback
                icon.className = 'bi bi-x-circle';
                btnText.textContent = 'Error';
                button.classList.remove('btn-primary', 'btn-saving');
                button.classList.add('btn-danger');
                
                // Show error message with toast
                Toast.error(data.error || 'Failed to save');
                
                // Auto-dismiss after 5 seconds
                setTimeout(() => {
                    if (saveIndicator && saveIndicator.parentElement) {
                        saveIndicator.remove();
                    }
                }, 5000);
                
                // Reset button after 3 seconds
                setTimeout(() => {
                    icon.className = originalIcon;
                    btnText.textContent = originalText;
                    button.classList.remove('btn-danger');
                    button.classList.add('btn-primary');
                    button.disabled = false;
                }, 3000);
            }
        })
        .catch(error => {
            // Network error
            icon.className = 'bi bi-x-circle';
            btnText.textContent = 'Error';
            button.classList.remove('btn-primary', 'btn-saving');
            button.classList.add('btn-danger');
            
            Toast.error('Network Error: ' + error.message);
            
            setTimeout(() => {
                if (saveIndicator && saveIndicator.parentElement) {
                    saveIndicator.remove();
                }
            }, 5000);
            
            setTimeout(() => {
                icon.className = originalIcon;
                btnText.textContent = originalText;
                button.classList.remove('btn-danger');
                button.classList.add('btn-primary');
                button.disabled = false;
            }, 3000);
        });
    }

    // Auto-save functionality
    let autoSaveTimeouts = {};
    let autoSaveSections = {
        'api_keys': ['linkedin_client_id', 'linkedin_client_secret', 'linkedin_access_token', 'linkedin_person_urn', 
                     'facebook_page_access_token', 'facebook_page_id',
                     'instagram_business_account_id', 'ayrshare_api_key'],
        'scheduling': ['scheduling_enabled', 'videos_per_day', 'schedule_day', 'youtube_schedule_time', 
                      'social_media_schedule_time', 'playlist_id', 'export_type', 'use_database', 
                      'auto_post_social', 'upload_method'],
        'social_platforms': ['social_platforms'],
        'thresholds': ['linkedin_daily_limit', 'facebook_daily_limit', 'instagram_daily_limit', 'youtube_daily_limit'],
        'targeting': ['target_audience', 'interview_types', 'role_levels'],
        'cta': ['booking_url', 'whatsapp_number', 'linkedin_url', 'instagram_url', 'facebook_url', 'youtube_url', 'twitter_url', 'website_url']
    };

    // Map inputs to their sections
    function getSectionForInput(inputName) {
        for (const [section, fields] of Object.entries(autoSaveSections)) {
            if (fields.includes(inputName) || inputName.startsWith('social_platforms') || 
                inputName.startsWith('interview_types') || inputName.startsWith('role_levels')) {
                return section;
            }
        }
        // Default mapping
        if (inputName.includes('linkedin') || inputName.includes('facebook') || 
            inputName.includes('instagram') || inputName.includes('ayrshare')) {
            return 'api_keys';
        }
        if (inputName.includes('limit') || inputName.includes('threshold')) {
            return 'thresholds';
        }
        if (inputName.includes('audience') || inputName.includes('interview') || inputName.includes('role')) {
            return 'targeting';
        }
        return 'scheduling';
    }

    // Auto-save function
    function autoSave(section, inputName) {
        // Clear existing timeout for this section
        if (autoSaveTimeouts[section]) {
            clearTimeout(autoSaveTimeouts[section]);
        }

        // Show saving indicator
        showAutoSaveIndicator(section, 'saving');

        // Set new timeout (2 seconds after user stops typing)
        autoSaveTimeouts[section] = setTimeout(() => {
            // Get the save button for this section
            const sectionCards = document.querySelectorAll('.card');
            let saveButton = null;
            
            for (const card of sectionCards) {
                const button = card.querySelector(`button[onclick*="saveSection('${section}'"]`);
                if (button) {
                    saveButton = button;
                    break;
                }
            }

            // Trigger auto-save (silent)
            autoSaveSection(section);
        }, 2000); // 2 second delay
    }

    // Show auto-save indicator
    function showAutoSaveIndicator(section, status) {
        // Remove existing indicator
        const existing = document.getElementById(`auto-save-indicator-${section}`);
        if (existing) {
            existing.remove();
        }

        // Create indicator
        const indicator = document.createElement('div');
        indicator.id = `auto-save-indicator-${section}`;
        indicator.className = 'auto-save-indicator';
        
        if (status === 'saving') {
            indicator.innerHTML = '<i class="bi bi-hourglass-split"></i> Saving...';
            indicator.className += ' saving';
        } else if (status === 'saved') {
            indicator.innerHTML = '<i class="bi bi-check-circle"></i> Saved';
            indicator.className += ' saved';
        }

        // Find the section card and append indicator
        const sectionCards = document.querySelectorAll('.card');
        for (const card of sectionCards) {
            const button = card.querySelector(`button[onclick*="saveSection('${section}'"]`);
            if (button) {
                const cardHeader = card.querySelector('.card-header');
                if (cardHeader) {
                    cardHeader.appendChild(indicator);
                    break;
                }
            }
        }

        // Auto-remove after 3 seconds if saved
        if (status === 'saved') {
            setTimeout(() => {
                if (indicator.parentElement) {
                    indicator.remove();
                }
            }, 3000);
        }
    }

    // Attach auto-save listeners to all inputs
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('configForm');
        if (!form) return;

        // Add event listeners to all inputs
        const inputs = form.querySelectorAll('input, select, textarea');
        inputs.forEach(input => {
            const inputName = input.name || input.id;
            if (!inputName) return;

            // Skip file inputs
            if (input.type === 'file') return;

            // Determine section
            const section = getSectionForInput(inputName);

            // Add event listeners
            if (input.type === 'checkbox' || input.type === 'radio') {
                input.addEventListener('change', () => {
                    autoSave(section, inputName);
                });
            } else {
                input.addEventListener('input', () => {
                    autoSave(section, inputName);
                });
            }
        });

        // Also handle checkboxes for social platforms, interview types, role levels
        const checkboxes = form.querySelectorAll('input[type="checkbox"][name^="social_platforms"], input[type="checkbox"][name^="interview_types"], input[type="checkbox"][name^="role_levels"]');
        checkboxes.forEach(cb => {
            cb.addEventListener('change', () => {
                const section = getSectionForInput(cb.name);
                autoSave(section, cb.name);
            });
        });
    });

    // Auto-save function (silent save without button animation)
    function autoSaveSection(section) {
        const form = document.getElementById('configForm');
        if (!form) return;
        
        const formData = {};
        
        // Collect form data (same logic as saveSection)
        if (section === 'api_keys') {
            const inputs = form.querySelectorAll('[name^="linkedin_"], [name^="facebook_page_"], [name^="instagram_"], [name="ayrshare_api_key"]');
            inputs.forEach(input => {
                if (input.type === 'checkbox') {
                    formData[input.name] = input.checked;
                } else {
                    formData[input.name] = input.value || '';
                }
            });
        } else if (section === 'scheduling') {
            formData.scheduling_enabled = form.querySelector('[name="scheduling_enabled"]')?.checked || false;
            formData.videos_per_day = parseInt(form.querySelector('[name="videos_per_day"]')?.value) || 1;
            formData.youtube_schedule_time = form.querySelector('[name="youtube_schedule_time"]')?.value || '';
            formData.social_media_schedule_time = form.querySelector('[name="social_media_schedule_time"]')?.value || '';
            formData.schedule_day = form.querySelector('[name="schedule_day"]')?.value || 'wednesday';
            formData.playlist_id = form.querySelector('[name="playlist_id"]')?.value || '';
            formData.export_type = form.querySelector('[name="export_type"]')?.value || 'shorts';
            formData.use_database = form.querySelector('[name="use_database"]')?.checked || true;
            formData.auto_post_social = form.querySelector('[name="auto_post_social"]')?.checked || false;
            formData.social_platforms = Array.from(form.querySelectorAll('[name="social_platforms"]:checked')).map(cb => cb.value);
            formData.upload_method = form.querySelector('[name="upload_method"]')?.value || 'native';
        } else if (section === 'social_media') {
            formData.auto_post_social = form.querySelector('[name="auto_post_social"]')?.checked || false;
            formData.social_platforms = Array.from(form.querySelectorAll('[name="social_platforms"]:checked')).map(cb => cb.value);
            formData.scheduling_enabled = form.querySelector('[name="scheduling_enabled"]')?.checked || false;
            formData.videos_per_day = parseInt(form.querySelector('[name="videos_per_day"]')?.value) || 1;
            formData.youtube_schedule_time = form.querySelector('[name="youtube_schedule_time"]')?.value || '';
            formData.social_media_schedule_time = form.querySelector('[name="social_media_schedule_time"]')?.value || '';
            formData.schedule_day = form.querySelector('[name="schedule_day"]')?.value || 'wednesday';
            formData.playlist_id = form.querySelector('[name="playlist_id"]')?.value || '';
            formData.export_type = form.querySelector('[name="export_type"]')?.value || 'shorts';
            formData.use_database = form.querySelector('[name="use_database"]')?.checked || true;
            formData.upload_method = form.querySelector('[name="upload_method"]')?.value || 'native';
            section = 'scheduling';
        } else if (section === 'thresholds') {
            formData.linkedin_daily_limit = parseInt(form.querySelector('[name="linkedin_daily_limit"]')?.value) || 25;
            formData.facebook_daily_limit = parseInt(form.querySelector('[name="facebook_daily_limit"]')?.value) || 25;
            formData.instagram_daily_limit = parseInt(form.querySelector('[name="instagram_daily_limit"]')?.value) || 25;
            formData.youtube_daily_limit = parseInt(form.querySelector('[name="youtube_daily_limit"]')?.value) || 10;
        } else if (section === 'targeting') {
            formData.target_audience = form.querySelector('[name="target_audience"]')?.value || 'usa_professionals';
            formData.interview_types = Array.from(form.querySelectorAll('[name="interview_types"]:checked')).map(cb => cb.value);
            formData.role_levels = Array.from(form.querySelectorAll('[name="role_levels"]:checked')).map(cb => cb.value);
        } else if (section === 'cta') {
            formData.booking_url = form.querySelector('[name="booking_url"]')?.value || 'https://fullstackmaster/book';
            formData.whatsapp_number = form.querySelector('[name="whatsapp_number"]')?.value || '+1-609-442-4081';
            formData.linkedin_url = form.querySelector('[name="linkedin_url"]')?.value || '';
            formData.instagram_url = form.querySelector('[name="instagram_url"]')?.value || '';
            formData.facebook_url = form.querySelector('[name="facebook_url"]')?.value || '';
            formData.youtube_url = form.querySelector('[name="youtube_url"]')?.value || '';
            formData.twitter_url = form.querySelector('[name="twitter_url"]')?.value || '';
            formData.website_url = form.querySelector('[name="website_url"]')?.value || '';
        }

        // Save silently
        fetch('/api/config/save-section', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ section: section, data: formData })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAutoSaveIndicator(section, 'saved');
            } else {
                console.error('Auto-save failed:', data.error);
            }
        })
        .catch(error => {
            console.error('Auto-save error:', error);
        });
    }
    
    // Disconnect functions
    function disconnectLinkedIn() {
        if (confirm('Are you sure you want to disconnect LinkedIn?')) {
            fetch('/api/linkedin/disconnect', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        Toast.success('LinkedIn disconnected successfully');
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        Toast.error('Error: ' + (data.error || 'Failed to disconnect'));
                    }
                });
        }
    }
    
    function disconnectFacebook() {
        if (confirm('Are you sure you want to disconnect Facebook?')) {
            fetch('/api/facebook/disconnect', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        Toast.success('Facebook disconnected successfully');
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        Toast.error('Error: ' + (data.error || 'Failed to disconnect'));
                    }
                });
        }
    }
</script>
{% endblock %}