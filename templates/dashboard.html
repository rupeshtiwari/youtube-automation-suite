{% extends "base.html" %}

{% block title %}Dashboard - YouTube Automation{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="bi bi-speedometer2"></i> Dashboard
        </h1>
    </div>
</div>

<div class="row">
    <div class="col-md-4">
        <div class="card">
            <div class="card-body text-center">
                <h5 class="card-title">Automation Status</h5>
                <div id="status-badge" class="status-badge status-inactive mt-3">
                    <i class="bi bi-pause-circle"></i> Inactive
                </div>
                <p class="text-muted mt-3 mb-0" id="status-message">Scheduling is disabled</p>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-body text-center">
                <h5 class="card-title">Last Run</h5>
                <h3 class="mt-3" id="last-run">
                    <i class="bi bi-clock-history"></i> Never
                </h3>
                <p class="text-muted mb-0">Last automation execution</p>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-body text-center">
                <h5 class="card-title">Next Run</h5>
                <h3 class="mt-3" id="next-run">
                    <i class="bi bi-calendar-event"></i> Not scheduled
                </h3>
                <p class="text-muted mb-0">Next automation execution</p>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-info-circle"></i> Quick Actions
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h5>Manual Execution</h5>
                        <p class="text-muted">Run automation tasks immediately</p>
                        <button class="btn btn-primary" id="run-now-btn" onclick="runNow()">
                            <i class="bi bi-play-circle"></i> Run Now
                        </button>
                    </div>
                    <div class="col-md-6">
                        <h5>Configuration</h5>
                        <p class="text-muted">Set up API keys and scheduling settings</p>
                        <a href="/config" class="btn btn-outline-primary me-2">
                            <i class="bi bi-gear"></i> Configure
                        </a>
                        <a href="/docs" class="btn btn-outline-secondary">
                            <i class="bi bi-book"></i> Documentation
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-list-check"></i> Current Settings
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Videos per day:</strong> <span
                                id="videos-per-day">{{ settings.scheduling.videos_per_day }}</span></p>
                        <p><strong>YouTube schedule time:</strong> <span
                                id="youtube-time">{{ settings.scheduling.youtube_schedule_time }}</span> IST</p>
                        <p><strong>Schedule day:</strong> <span
                                id="schedule-day">{{ settings.scheduling.schedule_day|title }}</span></p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Export type:</strong> <span
                                id="export-type">{{ settings.scheduling.export_type|title }}</span></p>
                        <p><strong>Auto-post social:</strong>
                            <span
                                class="badge bg-{{ 'success' if settings.scheduling.auto_post_social else 'secondary' }}">
                                {{ 'Yes' if settings.scheduling.auto_post_social else 'No' }}
                            </span>
                        </p>
                        <p><strong>Social platforms:</strong>
                            <span id="social-platforms">
                                {% for platform in settings.scheduling.social_platforms %}
                                <span class="badge bg-info">{{ platform|title }}</span>
                                {% endfor %}
                            </span>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function updateStatus() {
        fetch('/api/status')
            .then(response => response.json())
            .then(data => {
                const badge = document.getElementById('status-badge');
                const message = document.getElementById('status-message');
                const lastRun = document.getElementById('last-run');
                const nextRun = document.getElementById('next-run');

                if (data.enabled) {
                    badge.className = 'status-badge status-active mt-3';
                    badge.innerHTML = '<i class="bi bi-check-circle"></i> Active';
                    message.textContent = 'Automation is scheduled and running';
                } else {
                    badge.className = 'status-badge status-inactive mt-3';
                    badge.innerHTML = '<i class="bi bi-pause-circle"></i> Inactive';
                    message.textContent = 'Scheduling is disabled';
                }

                if (data.last_run) {
                    const date = new Date(data.last_run);
                    lastRun.innerHTML = `<i class="bi bi-clock-history"></i> ${date.toLocaleString()}`;
                }

                if (data.next_run) {
                    const date = new Date(data.next_run);
                    nextRun.innerHTML = `<i class="bi bi-calendar-event"></i> ${date.toLocaleString()}`;
                }
            })
            .catch(error => console.error('Error:', error));
    }

    function runNow() {
        const btn = document.getElementById('run-now-btn');
        btn.disabled = true;
        btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Running...';

        fetch('/api/run-now', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-play-circle"></i> Run Now';
                setTimeout(updateStatus, 2000);
            })
            .catch(error => {
                alert('Error: ' + error);
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-play-circle"></i> Run Now';
            });
    }

    // Update status every 30 seconds
    updateStatus();
    setInterval(updateStatus, 30000);
</script>
{% endblock %}